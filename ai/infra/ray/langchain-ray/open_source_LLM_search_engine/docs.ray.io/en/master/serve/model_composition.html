
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Model Composition &#8212; Ray 3.0.0.dev0</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css@digest=1999514e3f237ded88cf.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css@digest=5115cc725059bd94278eecd172e13a965bf8f5a9.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_/static/css/badge_only.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script src="../_static/js/rate-the-docs.es.min.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js@digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="../../../_/static/javascript/readthedocs-doc-embed.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/model_composition.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Development Workflow" href="dev-workflow.html" />
    <link rel="prev" title="Scaling and Resource Allocation" href="scaling-and-resource-allocation.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>


  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="../../../_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.com", "build_date": "2023-04-28T22:33:26Z", "builder": "sphinx", "canonical_url": null, "commit": "ff36b8e7", "docroot": "/doc/source/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-2", "language": "en", "page": "serve/model_composition", "programming_language": "py", "project": "anyscale-ray", "proxied_api_host": "/_", "source_suffix": ".md", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "master"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="../../../_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 3.0.0.dev0</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Welcome to Ray!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   Getting Started Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   Use Cases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray Core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-air/getting-started.html">
   Ray AI Runtime (AIR)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray Train
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune.html">
   Ray Tune
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray Serve
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="getting_started.html">
     Getting Started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     Key Concepts
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="user-guide.html">
     User Guides
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="http-guide.html">
       HTTP Handling
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="scaling-and-resource-allocation.html">
       Scaling and Resource Allocation
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="model_composition.html#">
       Model Composition
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="dev-workflow.html">
       Development Workflow
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="multi-app.html">
       Deploying Multiple Serve Applications
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="production-guide/index.html">
       Production Guide
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="performance.html">
       Performance Tuning
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="handling-dependencies.html">
       Handling Dependencies
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="managing-java-deployments.html">
       Experimental Java API
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="migration.html">
       1.x to 2.x API Migration Guide
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="direct-ingress.html">
       Experimental Direct Ingress
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="architecture.html">
     Architecture
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorials/index.html">
     Examples
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   More Libraries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/cluster/index.html">
   Ray Clusters
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/monitoring-debugging/monitoring-debugging.html">
   Monitoring and Debugging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/stability.html">
   Developer Guides
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/model_composition.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/model_composition.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/serve/model_composition.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="model_composition.html#composing-deployments-using-servehandles">
   Composing Deployments using ServeHandles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#model-composition-example">
     Model Composition Example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#servehandle-deep-dive">
     ServeHandle Deep Dive
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="model_composition.html#deployment-graph-api">
   Deployment Graph API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#binding-deployments">
     Binding Deployments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#building-the-call-graph-methodnodes-and-functionnodes">
     Building the Call Graph: MethodNodes and FunctionNodes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#drivers-and-http-adapters">
     Drivers and HTTP Adapters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#testing-the-graph-with-the-python-api">
     Testing the Graph with the Python API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#visualizing-the-graph">
     Visualizing the Graph
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Model Composition</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="model_composition.html#composing-deployments-using-servehandles">
   Composing Deployments using ServeHandles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#model-composition-example">
     Model Composition Example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#servehandle-deep-dive">
     ServeHandle Deep Dive
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="model_composition.html#deployment-graph-api">
   Deployment Graph API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#binding-deployments">
     Binding Deployments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#building-the-call-graph-methodnodes-and-functionnodes">
     Building the Call Graph: MethodNodes and FunctionNodes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#drivers-and-http-adapters">
     Drivers and HTTP Adapters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#testing-the-graph-with-the-python-api">
     Testing the Graph with the Python API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="model_composition.html#visualizing-the-graph">
     Visualizing the Graph
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="model-composition">
<span id="serve-model-composition"></span><h1>Model Composition<a class="headerlink" href="model_composition.html#model-composition" title="Permalink to this headline">#</a></h1>
<p>This section helps you:</p>
<ul class="simple">
<li><p>compose multiple deployments containing ML logic or business logic into a single application</p></li>
<li><p>independently scale and configure each of your ML models and business logic steps</p></li>
<li><p>connect your Ray Serve deployments together with the <strong>deployment graph</strong> API</p></li>
</ul>
<section id="composing-deployments-using-servehandles">
<span id="serve-handle-explainer"></span><h2>Composing Deployments using ServeHandles<a class="headerlink" href="model_composition.html#composing-deployments-using-servehandles" title="Permalink to this headline">#</a></h2>
<p>You can call deployment methods from within other deployments using the <a class="reference internal" href="key-concepts.html#serve-key-concepts-query-deployment"><span class="std std-ref">ServeHandle</span></a>. This lets you divide your application’s steps (such as preprocessing, model inference, and post-processing) into independent deployments that can be independently scaled and configured.</p>
<p>To use the <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code>, use <a class="reference internal" href="api/doc/ray.serve.handle.RayServeHandle.remote.html#ray.serve.handle.RayServeHandle.remote" title="ray.serve.handle.RayServeHandle.remote"><code class="xref py py-mod docutils literal notranslate"><span class="pre">handle.remote</span></code></a> to send requests to a deployment.
These requests can be ordinary Python args and kwargs that are passed directly to the method. This method call returns a Ray <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code> whose result can be waited for or retrieved using <code class="docutils literal notranslate"><span class="pre">await</span></code> or <code class="docutils literal notranslate"><span class="pre">ray.get</span></code>.</p>
<section id="model-composition-example">
<span id="serve-model-composition-serve-handles"></span><h3>Model Composition Example<a class="headerlink" href="model_composition.html#model-composition-example" title="Permalink to this headline">#</a></h3>
<p>Here’s an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># File name: hello.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">ray</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos"> 7</span><span class="k">class</span> <span class="nc">LanguageClassifer</span><span class="p">:</span>
<span class="linenos"> 8</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spanish_responder</span><span class="p">,</span> <span class="n">french_responder</span><span class="p">):</span>
<span class="linenos"> 9</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span> <span class="o">=</span> <span class="n">spanish_responder</span>
<span class="linenos">10</span>        <span class="bp">self</span><span class="o">.</span><span class="n">french_responder</span> <span class="o">=</span> <span class="n">french_responder</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_request</span><span class="p">):</span>
<span class="linenos">13</span>        <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos">14</span>        <span class="n">language</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<span class="linenos">15</span>
<span class="linenos">16</span>        <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;spanish&quot;</span><span class="p">:</span>
<span class="linenos">17</span>            <span class="n">ref</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">18</span>        <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;french&quot;</span><span class="p">:</span>
<span class="linenos">19</span>            <span class="n">ref</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">french_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">20</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">21</span>            <span class="k">return</span> <span class="s2">&quot;Please try again.&quot;</span>
<span class="linenos">22</span>
<span class="linenos">23</span>        <span class="k">return</span> <span class="k">await</span> <span class="n">ref</span>
<span class="linenos">24</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">27</span><span class="k">class</span> <span class="nc">SpanishResponder</span><span class="p">:</span>
<span class="linenos">28</span>    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">29</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hola </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">30</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">33</span><span class="k">class</span> <span class="nc">FrenchResponder</span><span class="p">:</span>
<span class="linenos">34</span>    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">35</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Bonjour </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">36</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="n">spanish_responder</span> <span class="o">=</span> <span class="n">SpanishResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="linenos">39</span><span class="n">french_responder</span> <span class="o">=</span> <span class="n">FrenchResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="linenos">40</span><span class="n">language_classifier</span> <span class="o">=</span> <span class="n">LanguageClassifer</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">spanish_responder</span><span class="p">,</span> <span class="n">french_responder</span><span class="p">)</span>
</pre></div>
</div>
<p>In line 40, the <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> deployment takes in the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> and <code class="docutils literal notranslate"><span class="pre">french_responder</span></code> as constructor arguments. At runtime, these arguments are converted into <code class="docutils literal notranslate"><span class="pre">ServeHandles</span></code>. <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> can then call the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> and <code class="docutils literal notranslate"><span class="pre">french_responder</span></code>’s deployment methods using this handle.</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code>’s <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method uses the HTTP request’s values to decide whether to respond in Spanish or French. It then forwards the request’s name to the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> or the <code class="docutils literal notranslate"><span class="pre">french_responder</span></code> on lines 17 and 19 using the <code class="docutils literal notranslate"><span class="pre">ServeHandles</span></code>. The calls are formatted as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>This call has a few parts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">await</span></code> lets us issue an asynchronous request through the <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.spanish_responder</span></code> is the <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> handle taken in through the constructor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">say_hello</span></code> is the <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> method to invoke.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remote</span></code> indicates that this is a <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code> call to another deployment. This is required when invoking a deployment’s method through another deployment. It needs to be added to the method name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is the argument for <code class="docutils literal notranslate"><span class="pre">say_hello</span></code>. You can pass any number of arguments or keyword arguments here.</p></li>
</ul>
<p>This call returns a reference to the result– not the result itself. This pattern allows the call to execute asynchronously. To get the actual result, <code class="docutils literal notranslate"><span class="pre">await</span></code> the reference. <code class="docutils literal notranslate"><span class="pre">await</span></code> blocks until the asynchronous call executes, and then it returns the result. In this example, line 23 calls <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">ref</span></code> and returns the resulting string. <strong>Note that getting the result needs two <code class="docutils literal notranslate"><span class="pre">await</span></code> statements in total</strong>. First, the script must <code class="docutils literal notranslate"><span class="pre">await</span></code> the <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code> call itself to retrieve a reference. Then it must <code class="docutils literal notranslate"><span class="pre">await</span></code> the reference to get the final result.</p>
<div class="admonition warning" id="serve-model-composition-await-warning">
<p class="admonition-title">Warning</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">ray.get(ref)</span></code> method to get the return value of remote <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code> calls. However, calling <code class="docutils literal notranslate"><span class="pre">ray.get</span></code> from inside a deployment is an antipattern. It blocks the deployment from executing any other code until the call is finished. Using <code class="docutils literal notranslate"><span class="pre">await</span></code> lets the deployment process other requests while waiting for the <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code> call to finish. You should use <code class="docutils literal notranslate"><span class="pre">await</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ray.get</span></code> inside deployments.</p>
</div>
<p>You can copy the <code class="docutils literal notranslate"><span class="pre">hello.py</span></code> script above and run it with <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code>. Make sure to run the command from a directory containing <code class="docutils literal notranslate"><span class="pre">hello.py</span></code>, so it can locate the script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>serve run hello:language_classifier
</pre></div>
</div>
<p>You can use this client script to interact with the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: hello_client.py</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;spanish&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dora&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">greeting</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<span class="nb">print</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span>
</pre></div>
</div>
<p>While the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> command is running, open a separate terminal window and run this script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python hello_client.py

<span class="go">Hola Dora</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Composition lets you break apart your application and independently scale each part. For instance, suppose this <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> application’s requests were 75% Spanish and 25% French. You could scale your <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> to have 3 replicas and your <code class="docutils literal notranslate"><span class="pre">FrenchResponder</span></code> to have 1 replica, so you could meet your workload’s demand. This flexibility also applies to reserving resources like CPUs and GPUs, as well as any other configurations you can set for each deployment.</p>
<p>With composition, you can avoid application-level bottlenecks when serving models and business logic steps that use different types and amounts of resources.</p>
</div>
</section>
<section id="servehandle-deep-dive">
<h3>ServeHandle Deep Dive<a class="headerlink" href="model_composition.html#servehandle-deep-dive" title="Permalink to this headline">#</a></h3>
<p>Conceptually, a <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code> is a client-side load balancer, routing requests to any replicas of a given deployment. Also, it performs buffering internally so it won’t overwhelm the replicas.
Using the current number of requests buffered, it informs the autoscaler to scale up the number of replicas.</p>
<p><img alt="architecture-diagram-of-serve-handle" src="https://raw.githubusercontent.com/ray-project/images/master/docs/serve/serve-handle-explainer.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code>s take request parameters and returns a future object of type <a class="reference internal" href="../ray-core/objects.html#objects-in-ray"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">ray.ObjectRef</span></code></span></a>, whose value will be filled with the result object. Because of the internal buffering, the time from submitting a request to getting a <code class="docutils literal notranslate"><span class="pre">ray.ObjectRef</span></code> can vary.</p>
<p>Because of this variability, Serve offers two types of handles to ensure the buffering period is handled efficiently. We offer synchronous and asynchronous versions of the handle:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RayServeSyncHandle</span></code> directly returns a <code class="docutils literal notranslate"><span class="pre">ray.ObjectRef</span></code>. It blocks the current thread until the request is matched to a replica.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RayServeDeploymentHandle</span></code> returns an <code class="docutils literal notranslate"><span class="pre">asyncio.Task</span></code> upon submission. The <code class="docutils literal notranslate"><span class="pre">asyncio.Task</span></code> can be awaited to resolve to a <code class="docutils literal notranslate"><span class="pre">ray.ObjectRef</span></code>. While the current request is buffered, other requests can be processed concurrently.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">serve.run</span></code> deploys a deployment graph and returns the entrypoint node’s handle (the node you passed as argument to <code class="docutils literal notranslate"><span class="pre">serve.run</span></code>). The return type is a <code class="docutils literal notranslate"><span class="pre">RayServeSyncHandle</span></code>. This is useful for interacting with and testing the newly created deployment graph.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">RayServeSyncHandle</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;hello&quot;</span>


<span class="n">handle</span><span class="p">:</span> <span class="n">RayServeSyncHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="n">ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>  <span class="c1"># blocks until request is assigned to replica</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>
</pre></div>
</div>
<p>In all other cases, <code class="docutils literal notranslate"><span class="pre">RayServeDeploymentHandle</span></code> is the default because the API is more performant than its blocking counterpart. For example, when implementing a dynamic dispatch node in deployment graph, the handle is asynchronous.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span> <span class="n">RayServeSyncHandle</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;hello&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">DynamicDispatcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">handle_a</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span> <span class="n">handle_b</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_a</span> <span class="o">=</span> <span class="n">handle_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_b</span> <span class="o">=</span> <span class="n">handle_b</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">handle_chosen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_a</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_b</span>

        <span class="c1"># The request is enqueued.</span>
        <span class="n">submission_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">handle_chosen</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
        <span class="c1"># The request is assigned to a replica.</span>
        <span class="n">ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="k">await</span> <span class="n">submission_task</span>
        <span class="c1"># The request has been processed by the replica.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ref</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="n">handle</span><span class="p">:</span> <span class="n">RayServeSyncHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">DynamicDispatcher</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>

</pre></div>
</div>
<p>The result of <code class="docutils literal notranslate"><span class="pre">deployment_handle.remote()</span></code> can also be passed directly as an argument to other downstream handles, without having to await on it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span> <span class="n">RayServeSyncHandle</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;hello &quot;</span> <span class="o">+</span> <span class="n">inp</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Chain</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">handle_a</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span> <span class="n">handle_b</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_a</span> <span class="o">=</span> <span class="n">handle_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_b</span> <span class="o">=</span> <span class="n">handle_b</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="n">ref</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_b</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
            <span class="c1"># Serve can handle enqueued-task as dependencies.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_a</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ref</span>


<span class="n">handle</span><span class="p">:</span> <span class="n">RayServeSyncHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Chain</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">()))</span>
<span class="n">ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;Serve&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;hello hello Serve&quot;</span>

</pre></div>
</div>
<p>In both types of <code class="docutils literal notranslate"><span class="pre">ServeHandle</span></code>, you can call a specific method by using the <code class="docutils literal notranslate"><span class="pre">.method_name</span></code> accessor. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">RayServeSyncHandle</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Deployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">method1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Method1: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;__call__: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">handle</span><span class="p">:</span> <span class="n">RayServeSyncHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Deployment</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">))</span>  <span class="c1"># Defaults to calling the __call__ method.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">))</span>  <span class="c1"># Call a different method.</span>

</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">ray.ObjectRef</span></code> corresponds to the result of a request submission. To retrieve the result, you can use the synchronous Ray Core API <code class="docutils literal notranslate"><span class="pre">ray.get(ref)</span></code> or the async API <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">ref</span></code>. To wait for the result to be available without retrieving it, you can use the synchronous API <code class="docutils literal notranslate"><span class="pre">ray.wait([ref])</span></code> or the async API <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">asyncio.wait([ref])</span></code>. You can mix and match these calls, but we recommend using async APIs to increase concurrency.</p>
</div>
</section>
</section>
<section id="deployment-graph-api">
<span id="serve-model-composition-deployment-graph"></span><h2>Deployment Graph API<a class="headerlink" href="model_composition.html#deployment-graph-api" title="Permalink to this headline">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The call graph is in <strong>alpha</strong>, so its APIs are subject to change.</p>
</div>
<p>For more advanced composition patterns, it can be useful to surface the relationships between deployments, instead of hiding them inside individual deployment definitions.</p>
<p>Ray Serve’s <strong>deployment graph API</strong> lets you specify how to route requests through your deployments, so you can explicitly create a dependency graph. It also has additional features like HTTP adapters and input routing that help you build more expressive graphs.</p>
<section id="binding-deployments">
<h3>Binding Deployments<a class="headerlink" href="model_composition.html#binding-deployments" title="Permalink to this headline">#</a></h3>
<p>The basic building block for all deployment graphs is the <code class="docutils literal notranslate"><span class="pre">DeploymentNode</span></code>. One type of <code class="docutils literal notranslate"><span class="pre">DeploymentNode</span></code> is the <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code>. You can create <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code> by binding class-based deployments to their constructor’s arguments with the <code class="docutils literal notranslate"><span class="pre">bind</span></code> method. This may sound familiar because you’ve already been doing this whenever you bind and run class-based deployments, such as in the <a class="reference internal" href="model_composition.html#serve-model-composition-serve-handles"><span class="std std-ref">Calling Deployments using ServeHandles</span></a> section.</p>
<p>As another example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: echo.py</span>
<span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">EchoClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">echo_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo_str</span> <span class="o">=</span> <span class="n">echo_str</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo_str</span>


<span class="c1"># You can create ClassNodes from the EchoClass deployment</span>
<span class="n">foo_node</span> <span class="o">=</span> <span class="n">EchoClass</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="n">bar_node</span> <span class="o">=</span> <span class="n">EchoClass</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
<span class="n">baz_node</span> <span class="o">=</span> <span class="n">EchoClass</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">echo.py</span></code> defines three <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>: <code class="docutils literal notranslate"><span class="pre">foo_node</span></code>, <code class="docutils literal notranslate"><span class="pre">bar_node</span></code>, and <code class="docutils literal notranslate"><span class="pre">baz_node</span></code>. The nodes are defined by invoking <code class="docutils literal notranslate"><span class="pre">bind</span></code> on the <code class="docutils literal notranslate"><span class="pre">EchoClass</span></code> deployment. They have different behaviors because they use different arguments in the <code class="docutils literal notranslate"><span class="pre">bind</span></code> call.</p>
<p>Note that all three of these nodes were created from the same <code class="docutils literal notranslate"><span class="pre">EchoClass</span></code> deployment. Class deployments are essentially factories for <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>. A single class deployment can produce multiple <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code> through multiple <code class="docutils literal notranslate"><span class="pre">bind</span></code> statements.</p>
<p>There are two options to run a node:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">serve.run(node)</span></code>: This Python call can be added to your Python script to run a particular node. This call starts a Ray cluster (if one isn’t already running), deploys the node to it, and then returns. You can call this function multiple times in the same script on different <code class="docutils literal notranslate"><span class="pre">DeploymentNodes</span></code>. Each time, it tears down any deployments it previously deployed and deploy the passed-in node’s deployment. After the script exits, the cluster and any nodes deployed by <code class="docutils literal notranslate"><span class="pre">serve.run</span></code> are torn down.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span> <span class="pre">module:node</span></code>: This CLI command starts a Ray cluster and runs the node at the import path <code class="docutils literal notranslate"><span class="pre">module:node</span></code>. It then blocks, allowing you to open a separate terminal window and issue requests to the running deployment. You can stop the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> command with <code class="docutils literal notranslate"><span class="pre">ctrl-c</span></code>.</p></li>
</ol>
<p>When you run a node, you are deploying the node’s deployment and its bound arguments. Ray Serve creates a deployment in Ray and instantiates your deployment’s class using the arguments. By default, you can send requests to your deployment at <code class="docutils literal notranslate"><span class="pre">http://localhost:8000</span></code>. These requests are converted to Starlette <code class="docutils literal notranslate"><span class="pre">request</span></code> objects and passed to your class’s <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Additionally, when you run a node, the deployment’s configurations (which you can set in the <code class="docutils literal notranslate"><span class="pre">&#64;serve.deployment</span></code> decorator, through an <code class="docutils literal notranslate"><span class="pre">options</span></code> call, or a <a class="reference internal" href="production-guide/config.html#serve-in-production-config-file"><span class="std std-ref">Serve config file</span></a>) still apply to the deployment. You can use this to independently scale and configure your graph’s deployments by, for instance, setting different <code class="docutils literal notranslate"><span class="pre">num_replicas</span></code>, <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>, or <code class="docutils literal notranslate"><span class="pre">num_gpus</span></code> values for different deployments.</p>
</div>
<p>You can try this example out using the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> CLI:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>serve run echo:foo_node
</pre></div>
</div>
<p>Here’s a client script that can send requests to your node:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: echo_client.py</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/&quot;</span><span class="p">)</span>
<span class="n">echo</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<span class="nb">print</span><span class="p">(</span><span class="n">echo</span><span class="p">)</span>
</pre></div>
</div>
<p>While the deployment is running with <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code>, open a separate terminal window and issue a request to it with the <code class="docutils literal notranslate"><span class="pre">echo_client.py</span></code> script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python echo_client.py

foo
</pre></div>
</div>
</section>
<section id="building-the-call-graph-methodnodes-and-functionnodes">
<span id="deployment-graph-call-graph"></span><h3>Building the Call Graph: MethodNodes and FunctionNodes<a class="headerlink" href="model_composition.html#building-the-call-graph-methodnodes-and-functionnodes" title="Permalink to this headline">#</a></h3>
<p>After defining your <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>, you can specify how HTTP requests should be processed using the call graph. As an example, let’s look at a deployment graph that implements this chain of arithmetic operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">request</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Here’s the graph:</p>
<div class="highlight-python notranslate" id="deployment-graph-arithmetic-graph"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># File name: arithmetic.py</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">ray.serve.drivers</span> <span class="kn">import</span> <span class="n">DAGDriver</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">ray.serve.deployment_graph</span> <span class="kn">import</span> <span class="n">InputNode</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">10</span><span class="k">class</span> <span class="nc">AddCls</span><span class="p">:</span>
<span class="linenos">11</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addend</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="linenos">12</span>        <span class="bp">self</span><span class="o">.</span><span class="n">addend</span> <span class="o">=</span> <span class="n">addend</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">15</span>        <span class="k">return</span> <span class="n">number</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">addend</span>
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unpack_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">18</span>        <span class="k">return</span> <span class="k">await</span> <span class="n">http_request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos">19</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">22</span><span class="k">def</span> <span class="nf">subtract_one_fn</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">23</span>    <span class="k">return</span> <span class="n">number</span> <span class="o">-</span> <span class="mi">1</span>
<span class="linenos">24</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">27</span><span class="k">async</span> <span class="k">def</span> <span class="nf">unpack_request</span><span class="p">(</span><span class="n">http_request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">28</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">http_request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos">29</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="n">add_2</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">32</span><span class="n">add_3</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="k">with</span> <span class="n">InputNode</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_request</span><span class="p">:</span>
<span class="linenos">35</span>    <span class="n">request_number</span> <span class="o">=</span> <span class="n">unpack_request</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">http_request</span><span class="p">)</span>
<span class="linenos">36</span>    <span class="n">add_2_output</span> <span class="o">=</span> <span class="n">add_2</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">request_number</span><span class="p">)</span>
<span class="linenos">37</span>    <span class="n">subtract_1_output</span> <span class="o">=</span> <span class="n">subtract_one_fn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_2_output</span><span class="p">)</span>
<span class="linenos">38</span>    <span class="n">add_3_output</span> <span class="o">=</span> <span class="n">add_3</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">subtract_1_output</span><span class="p">)</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="n">graph</span> <span class="o">=</span> <span class="n">DAGDriver</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_3_output</span><span class="p">)</span>
</pre></div>
</div>
<p>Lines 31 and 32 bind two <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code> from the <code class="docutils literal notranslate"><span class="pre">AddCls</span></code> deployment. Line 34 starts the call graph:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InputNode</span><span class="p">()</span> <span class="k">as</span> <span class="n">http_request</span><span class="p">:</span>
    <span class="n">request_number</span> <span class="o">=</span> <span class="n">unpack_request</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">http_request</span><span class="p">)</span>
    <span class="n">add_2_output</span> <span class="o">=</span> <span class="n">add_2</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">request_number</span><span class="p">)</span>
    <span class="n">subtract_1_output</span> <span class="o">=</span> <span class="n">subtract_one_fn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_2_output</span><span class="p">)</span>
    <span class="n">add_3_output</span> <span class="o">=</span> <span class="n">add_3</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">subtract_1_output</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">with</span></code> statement (known as a “context manager” in Python) initializes a special Ray Serve-provided object called an <code class="docutils literal notranslate"><span class="pre">InputNode</span></code>. This isn’t a <code class="docutils literal notranslate"><span class="pre">DeploymentNode</span></code> like <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>, <code class="docutils literal notranslate"><span class="pre">MethodNodes</span></code>, or <code class="docutils literal notranslate"><span class="pre">FunctionNodes</span></code>. Rather, it’s the input of the graph. In this case, that input is an HTTP request. In a <a class="reference internal" href="model_composition.html#deployment-graph-drivers-http-adapters"><span class="std std-ref">later section</span></a>, you’ll learn how to change this input using another Ray Serve-provided object called the <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code>.</p>
<div class="admonition note" id="deployment-graph-call-graph-input-node-note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> tells Ray Serve where to send the graph input at runtime. In this example, for instance, <code class="docutils literal notranslate"><span class="pre">http_request</span></code> is an <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> object, so you can’t call <code class="docutils literal notranslate"><span class="pre">request</span></code> methods like <code class="docutils literal notranslate"><span class="pre">.json()</span></code> on it directly in the context manager. However, during runtime, Ray Serve passes incoming HTTP requests directly into the same functions and methods that <code class="docutils literal notranslate"><span class="pre">http_request</span></code> is passed into, so those functions and methods can call <code class="docutils literal notranslate"><span class="pre">request</span></code> methods like <code class="docutils literal notranslate"><span class="pre">.json()</span></code> on the <code class="docutils literal notranslate"><span class="pre">request</span></code> object that gets passed in.</p>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> to indicate which node(s) the graph input should be passed into by passing the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> into <code class="docutils literal notranslate"><span class="pre">bind</span></code> calls within the context manager. In this example, the <code class="docutils literal notranslate"><span class="pre">http_request</span></code> is passed to only one node, <code class="docutils literal notranslate"><span class="pre">unpack_request</span></code>. The output of that bind call, <code class="docutils literal notranslate"><span class="pre">request_number</span></code>, is a <code class="docutils literal notranslate"><span class="pre">FunctionNode</span></code>. <code class="docutils literal notranslate"><span class="pre">FunctionNodes</span></code> are produced when deployments containing functions are bound to arguments for that function using <code class="docutils literal notranslate"><span class="pre">bind</span></code>. <code class="docutils literal notranslate"><span class="pre">request_number</span></code> represents the output of <code class="docutils literal notranslate"><span class="pre">unpack_request</span></code> when called on incoming HTTP requests. <code class="docutils literal notranslate"><span class="pre">unpack_request</span></code>, which is defined on line 26, processes the HTTP request’s JSON body and returns a number that can be passed into arithmetic operations.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you don’t want to manually unpack HTTP requests, check out this guide’s section on <a class="reference internal" href="model_composition.html#deployment-graph-drivers-http-adapters"><span class="std std-ref">HTTP adapters</span></a>, which can handle unpacking for you.</p>
</div>
<p>The graph then passes <code class="docutils literal notranslate"><span class="pre">request_number</span></code> into a <code class="docutils literal notranslate"><span class="pre">bind</span></code> call on <code class="docutils literal notranslate"><span class="pre">add_2</span></code>’s <code class="docutils literal notranslate"><span class="pre">add</span></code> method. The output of this call, <code class="docutils literal notranslate"><span class="pre">add_2_output</span></code> is a <code class="docutils literal notranslate"><span class="pre">MethodNode</span></code>. <code class="docutils literal notranslate"><span class="pre">MethodNodes</span></code> are produced when <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code> methods are bound to arguments using <code class="docutils literal notranslate"><span class="pre">bind</span></code>. In this case, <code class="docutils literal notranslate"><span class="pre">add_2_output</span></code> represents the result of adding 2 to the number in the request.</p>
<p>The rest of the call graph uses another <code class="docutils literal notranslate"><span class="pre">FunctionNode</span></code> and <code class="docutils literal notranslate"><span class="pre">MethodNode</span></code> to finish the chain of arithmetic. <code class="docutils literal notranslate"><span class="pre">add_2_output</span></code> is bound to the <code class="docutils literal notranslate"><span class="pre">subtract_one_fn</span></code> deployment, producing the <code class="docutils literal notranslate"><span class="pre">subtract_1_output</span></code> <code class="docutils literal notranslate"><span class="pre">FunctionNode</span></code>. Then, the <code class="docutils literal notranslate"><span class="pre">subtract_1_output</span></code> is bound to the <code class="docutils literal notranslate"><span class="pre">add_3.add</span></code> method, producing the <code class="docutils literal notranslate"><span class="pre">add_3_output</span></code> <code class="docutils literal notranslate"><span class="pre">MethodNode</span></code>. This <code class="docutils literal notranslate"><span class="pre">add_3_output</span></code> <code class="docutils literal notranslate"><span class="pre">MethodNode</span></code> represents the final output from the chain of arithmetic operations.</p>
<p>To run the call graph, you need to use a driver. Drivers are deployments that process the call graph that you’ve written and route incoming requests through your deployments based on that graph. Ray Serve provides a driver called <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> used on line 40:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">DAGDriver</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_3_output</span><span class="p">)</span>
</pre></div>
</div>
<p>Generally, the <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> needs to be bound to the <code class="docutils literal notranslate"><span class="pre">FunctionNode</span></code> or <code class="docutils literal notranslate"><span class="pre">MethodNode</span></code> representing the final output of a graph. This <code class="docutils literal notranslate"><span class="pre">bind</span></code> call returns a <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code> that you can run in <code class="docutils literal notranslate"><span class="pre">serve.run</span></code> or <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code>. Running this <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code> also deploys the rest of the graph’s deployments.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> can also be bound to <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>. This is useful if you construct a deployment graph where <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code> invoke other <code class="docutils literal notranslate"><span class="pre">ClassNodes</span></code>’ methods. In this case, you should pass in the “root” <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code> to <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> (i.e. the one that you would otherwise pass into <code class="docutils literal notranslate"><span class="pre">serve.run</span></code>). Check out the <a class="reference internal" href="model_composition.html#serve-model-composition-serve-handles"><span class="std std-ref">Calling Deployments using ServeHandles</span></a> section for more info.</p>
</div>
<p>You can test this example using this client script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: arithmetic_client.py</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>Start the graph in the terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>serve run arithmetic:graph
</pre></div>
</div>
<p>In a separate terminal window, run the client script to make requests to the graph:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python arithmetic_client.py

<span class="go">9</span>
</pre></div>
</div>
</section>
<section id="drivers-and-http-adapters">
<span id="deployment-graph-drivers-http-adapters"></span><h3>Drivers and HTTP Adapters<a class="headerlink" href="model_composition.html#drivers-and-http-adapters" title="Permalink to this headline">#</a></h3>
<p>Ray Serve provides the <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code>, which routes HTTP requests through your call graph. As mentioned in <a class="reference internal" href="model_composition.html#deployment-graph-call-graph"><span class="std std-ref">the call graph section</span></a>, the <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> takes in a <code class="docutils literal notranslate"><span class="pre">DeploymentNode</span></code> and it produces a <code class="docutils literal notranslate"><span class="pre">ClassNode</span></code> that you can run.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> also has an optional keyword argument: <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code>. <a class="reference internal" href="http-guide.html#serve-http-adapters"><span class="std std-ref">HTTP adapters</span></a> are functions that get run on the HTTP request before it’s passed into the graph. Ray Serve provides a handful of these adapters, so you can rely on them to conveniently handle the HTTP parsing while focusing your attention on the graph itself.</p>
<p>For instance, you can use the Ray Serve-provided <code class="docutils literal notranslate"><span class="pre">json_request</span></code> adapter to simplify the <a class="reference internal" href="model_composition.html#deployment-graph-arithmetic-graph"><span class="std std-ref">arithmetic call graph</span></a> by eliminating the <code class="docutils literal notranslate"><span class="pre">unpack_request</span></code> function. You can replace lines 29 through 38 with this graph:</p>
<div class="highlight-python notranslate" id="http-adapter-arithmetic-example"><div class="highlight"><pre><span></span><span class="c1"># This import can go to the top of the file.</span>
<span class="kn">from</span> <span class="nn">ray.serve.http_adapters</span> <span class="kn">import</span> <span class="n">json_request</span>

<span class="n">add_2</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">add_3</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">with</span> <span class="n">InputNode</span><span class="p">()</span> <span class="k">as</span> <span class="n">request_number</span><span class="p">:</span>
    <span class="n">add_2_output</span> <span class="o">=</span> <span class="n">add_2</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">request_number</span><span class="p">)</span>
    <span class="n">subtract_1_output</span> <span class="o">=</span> <span class="n">subtract_one_fn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_2_output</span><span class="p">)</span>
    <span class="n">add_3_output</span> <span class="o">=</span> <span class="n">add_3</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">subtract_1_output</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">DAGDriver</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_3_output</span><span class="p">,</span> <span class="n">http_adapter</span><span class="o">=</span><span class="n">json_request</span><span class="p">)</span>
</pre></div>
</div>
<p>Without an <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code>, an <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> <a class="reference internal" href="model_composition.html#deployment-graph-call-graph-input-node-note"><span class="std std-ref">represents an HTTP request</span></a>, and at runtime, incoming HTTP <code class="docutils literal notranslate"><span class="pre">request</span></code> objects are passed into the same functions and methods that the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> is passed into. When you set an <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code>, the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> represents the <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code>’s output.</p>
<p>At runtime:</p>
<ol class="simple">
<li><p>Ray Serve sends each HTTP <code class="docutils literal notranslate"><span class="pre">request</span></code> object to the <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> calls the <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code> function on each request.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">DAGDriver</span></code> passes the <code class="docutils literal notranslate"><span class="pre">http_adapter</span></code> output to the same function and methods that the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> is passed into, kicking off the request’s journey through the call graph.</p></li>
</ol>
<p>In the example above, the <code class="docutils literal notranslate"><span class="pre">InputNode</span></code> represents the number packaged inside the request’s JSON body instead of the HTTP request itself. You can pass the JSON directly into the graph instead of first unpacking it from the request.</p>
<p>See <a class="reference internal" href="http-guide.html#serve-http-adapters"><span class="std std-ref">the guide</span></a> on <code class="docutils literal notranslate"><span class="pre">http_adapters</span></code> to learn more.</p>
</section>
<section id="testing-the-graph-with-the-python-api">
<span id="deployment-graph-call-graph-testing"></span><h3>Testing the Graph with the Python API<a class="headerlink" href="model_composition.html#testing-the-graph-with-the-python-api" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">serve.run</span></code> function returns a handle that you can use to test your graph in Python, without using HTTP requests.</p>
<p>To test your graph,</p>
<ol class="simple">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">serve.run</span></code> on your graph and store the returned handle.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">handle.predict.remote(input)</span></code>. <strong>The <code class="docutils literal notranslate"><span class="pre">input</span></code> argument becomes the input represented by <code class="docutils literal notranslate"><span class="pre">InputNode</span></code></strong>. Make sure to refactor your call graph accordingly, since it takes in this input directly, instead of an HTTP request. You can use an <a class="reference internal" href="model_composition.html#deployment-graph-drivers-http-adapters"><span class="std std-ref">HTTP adapter</span></a> to make sure the graph you’re testing matches the one you ultimately deploy.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">predict.remote</span></code> returns a reference to the result, so the graph can execute asynchronously. Call <code class="docutils literal notranslate"><span class="pre">ray.get</span></code> on this reference to get the final result.</p></li>
</ol>
<p>As an example, you can continue rewriting the <a class="reference internal" href="model_composition.html#http-adapter-arithmetic-example"><span class="std std-ref">arithmetic graph example</span></a> from above to use <code class="docutils literal notranslate"><span class="pre">predict.remote</span></code>. You can add testing code to the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These imports can go to the top of the file.</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray.serve.http_adapters</span> <span class="kn">import</span> <span class="n">json_request</span>

<span class="n">add_2</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">add_3</span> <span class="o">=</span> <span class="n">AddCls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">with</span> <span class="n">InputNode</span><span class="p">()</span> <span class="k">as</span> <span class="n">request_number</span><span class="p">:</span>
    <span class="n">add_2_output</span> <span class="o">=</span> <span class="n">add_2</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">request_number</span><span class="p">)</span>
    <span class="n">subtract_1_output</span> <span class="o">=</span> <span class="n">subtract_one_fn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_2_output</span><span class="p">)</span>
    <span class="n">add_3_output</span> <span class="o">=</span> <span class="n">add_3</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">subtract_1_output</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">DAGDriver</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">add_3_output</span><span class="p">,</span> <span class="n">http_adapter</span><span class="o">=</span><span class="n">json_request</span><span class="p">)</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="n">ref</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the graph itself is still the same. The only change is the testing code added after it. You can run this Python script directly now to test the graph:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python arithmetic.py

9
</pre></div>
</div>
</section>
<section id="visualizing-the-graph">
<span id="pydot-visualize-dag"></span><h3>Visualizing the Graph<a class="headerlink" href="model_composition.html#visualizing-the-graph" title="Permalink to this headline">#</a></h3>
<p>You can render an illustration of your deployment graph to see its nodes and their connection.</p>
<p>Make sure you have <code class="docutils literal notranslate"><span class="pre">pydot</span></code> and <code class="docutils literal notranslate"><span class="pre">graphviz</span></code> to follow this section:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
MacOS</label><div class="sd-tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pydot</span> <span class="o">&amp;&amp;</span> <span class="n">brew</span> <span class="n">install</span> <span class="n">graphviz</span>
</pre></div>
</div>
</div>
</div>
<div class="sd-tab-item docutils">
<p class="sd-tab-label rubric">Windows</p>
<div class="sd-tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pydot</span> <span class="o">&amp;&amp;</span> <span class="n">winget</span> <span class="n">install</span> <span class="n">graphviz</span>
</pre></div>
</div>
</div>
</div>
<div class="sd-tab-item docutils">
<p class="sd-tab-label rubric">Linux</p>
<div class="sd-tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pydot</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">graphviz</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
Here&#39;s an example graph:

```{literalinclude} doc_code/model_composition/deployment_graph_viz.py
:language: python
```

The `ray.dag.vis_utils._dag_to_dot` method takes in a `DeploymentNode` and produces a graph visualization. You can see the string form of the visualization by running the script:

```console
$ python deployment_graph_viz.py

digraph G {
rankdir=LR;
INPUT_ATTRIBUTE_NODE -&gt; forward;
INPUT_NODE -&gt; INPUT_ATTRIBUTE_NODE;
Model -&gt; forward;
}

digraph G {
rankdir=LR;
forward -&gt; combine;
INPUT_ATTRIBUTE_NODE -&gt; forward;
INPUT_NODE -&gt; INPUT_ATTRIBUTE_NODE;
Model -&gt; forward;
forward_1 -&gt; combine;
INPUT_ATTRIBUTE_NODE_1 -&gt; forward_1;
INPUT_NODE -&gt; INPUT_ATTRIBUTE_NODE_1;
Model_1 -&gt; forward_1;
INPUT_ATTRIBUTE_NODE_2 -&gt; combine;
INPUT_NODE -&gt; INPUT_ATTRIBUTE_NODE_2;
}
```

You can render these strings in `graphviz` tools such as [https://dreampuf.github.io/GraphvizOnline](https://dreampuf.github.io/GraphvizOnline).

When the script visualizes `m1_output`, it shows a partial execution path of the entire graph:

![pic](https://raw.githubusercontent.com/ray-project/images/master/docs/serve/deployment-graph/visualize_partial.svg)

This path includes only the dependencies needed to generate `m1_output`.

On the other hand, when the script visualizes the final graph output, `combine_output`, it captures all nodes used in execution since they&#39;re all required to create the final output.

![pic](https://raw.githubusercontent.com/ray-project/images/master/docs/serve/deployment-graph/visualize_full.svg)

#### Visualizing the Graph with Gradio
Another option is to visualize your deployment graph through Gradio. Check out the [Graph Visualization with Gradio Tutorial](serve-gradio-dag-visualization) to learn how to interactively run your deployment graph through the Gradio UI and see the intermediate outputs of each node in real time as they finish evaluation.

## Next Steps

To learn more about deployment graphs, check out some [deployment graph patterns](serve-deployment-graph-patterns-overview) you can incorporate into your own graph!
</pre></div>
</div>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="scaling-and-resource-allocation.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Scaling and Resource Allocation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="dev-workflow.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Development Workflow</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2023, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js@digest=1999514e3f237ded88cf"></script>


  </body>
</html>